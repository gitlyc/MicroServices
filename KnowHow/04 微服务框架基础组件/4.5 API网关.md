#### API网关

在设计模式中，外观模式的设计意图在于为子系统中的一组接口提供一个一致的入口，这个入口使得这一子系统更加容易使用，实现上用户界面不与系统耦合，而外观类与系统耦合。在层次化结构中，可以使用外观模式定义系统中的每一层的入口。

外观模式：封装许多对象，以简化它们的接口，此模式定义了一个高层的接口，这个接口使得这一子系统更加容易使用，如下图：

![外观模式](D:\documents\技术文档\md\MicroServices\KnowHow\00 common\images\04\外观模式.png)

API网关本质上就是一种外观模式的具体实现，它是一种服务器端应用程序并作为系统访问的唯一入口。在微服务架构中，API网关的核心要点是，所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能。

##### 1. API网关的作用

微服务提供的API粒度与客户端的要求不一定完全匹配，微服务一般提供细粒度的API，这意味着客户端通常需要与多个服务进行交互，网关要起到客户端与微服务间的隔离作用，随着业务需求的变化和时间的演进，网关背后的各个微服务的划分和实现可能需要做相应的调整和升级，这种调整和升级要求对客户端透明。

![API网关模式](D:\documents\技术文档\md\MicroServices\KnowHow\00 common\images\04\API网关模式.png)

API网关的作用主要体现在以下三个方面：

1. 解耦：

   API网关使客户端和服务器端在调用关系和部署环境上进行解耦，向客户端隐藏了应用如何被划分到微服务的细节。

2. API优化：

   要求对每个客户端提供最优的API，在多客户端场景中，对于同一个业务请求，不同的客户端一般需要不同的数据。

3. 简化调用过程：

   可以对返回数据进行处理，API网关减少了请求往返的次数，从而简化客户端的调用，提高服务访问的性能。

但是需要注意的是，API网关也增加了系统的复杂性和响应时间，通过API网关也多了一层网络跳转，但是我们认为API网关模式的缺点相比优点是微不足道的。

##### 2. 网关的功能

网关的基本功能基本包含五点，具体细分如下图：

![网关的功能](D:\documents\技术文档\md\MicroServices\KnowHow\00 common\images\04\网关的功能.png)

- NIO接入和异步接出：

  由于API网关作为客户端和微服务之间提供了桥梁，增加了一层网络跳转，为了解决网络跳转带来的性能影响，在实现上需要提供NIO接入和异步接出功能。

- 报文格式转换：

  API网关作为单一入口，可构建异构系统，通过协议转换整合后基于REST、AMQP和Dubbo等不同风格和实现技术的微服务。

![API网关与异构系统](D:\documents\技术文档\md\MicroServices\KnowHow\00 common\images\04\API网关与异构系统.png)

- 安全性控制：

  API网关是统一管理安全性的绝佳场所，可以将认证的部分抽离到网关层，然后微服务系统无需关注认证的逻辑只关注自身业务即可。

- 访问控制：

  需要控制客户端的访问次数和访问频率等功能。

- 业务路由支持：

  可在网关层制定灵活的路由策略，对于特定API可设置白名单、路由规则等限制，非业务功能的配置及变更在网关层单独操作。