#### 事件驱动

事件驱动架构定义了一个设计和实现应用系统的架构风格，在这个架构风格里，事件可以传输于松耦合的组件和服务之间。

##### 1. 基本的事件架构

基本事件驱动处理架构的优势在于当系统中需要添加另一个业务逻辑来完成整体流程时，只需要对该事件添加一个订阅者即可，不需要对原系统做任何修改。

![基本事件架构](D:\documents\技术文档\md\MicroServices\KnowHow\00 common\images\04\基本事件架构.png)

如图，一个订单处理的基本场景中需要预约订单处理系统同时知道支付、物流和账单服务，并进行服务的调用和协调，完成业务的闭环，但是，如果当系统业务进行变更后，需要一个新的服务才能完成所需要的业务流程，那么原有交互模式就需要进行调整，不利用系统扩展。

如果我们采用事件驱动架构来实现的话，当一个订单操作完成时，订单系统就可以发送一个事件用于表示这个操作已完成，并触发所有对该事件感兴趣的微服务，这些微服务相当于这个事件的订阅者和消费者，这样一来，一个微服务可以处理支付，一个微服务处理物流，另一个微服务则处理账单，三个事件通过事件进行了解耦，通过消息传递机制，不必花费太大代价就能实现事件驱动架构。

##### 2. 事件驱动与领域模型

如图，一种领域事件框架围绕领域事件生命周期给出了三种不同的处理方式，体现在不同是事件订阅者。

![事件驱动与领域模型](D:\documents\技术文档\md\MicroServices\KnowHow\00 common\images\04\事件驱动与领域模型.png)

- 简单订阅者：

直接处理事件，表现为一个独立的事件处理程序，对应于事件的使用阶段。

- 即时转发订阅者：

对应于事件的分发和使用阶段，一方面可以具备简单订阅者的功能，另一方面也可以把事件转发给其他订阅者（消息队列是一个较好地实践方法）。

- 事件存储订阅者：

在处理事件的同时对事件进行持久化，存储的事件可以作为一种历史记录，也可以通过专门的事件转发器转发到消息队列，对应于事件的存车使用阶段。

如下图，在架构设计上，对领域事件的处理就是基本的发布-订阅风格。

![事件的发布与订阅](D:\documents\技术文档\md\MicroServices\KnowHow\00 common\images\04\事件的发布与订阅.png)

其中，DomainEvent本身具备一定的类型，DomainEventSubscriber根据类型订阅某种特定的DomainEvent，领域对象间的交互图一般如下：

![发布订阅时序图](D:\documents\技术文档\md\MicroServices\KnowHow\00 common\images\04\发布订阅时序图.png)

应用层AplicationService对某个实体对象进行操作会触发领域事件的生成，领域事件通过DomainEventPublisher进行发布，DomainEventSubscriber则根据需要由AplicationService创建并根据事件类型进行订阅和处理。而包含事件存储的发布订阅时序图一般如下，针对远程交互本身存在的网络稳定性等各种不可控原因会对事件进行存储以便发生问题时跟踪和重试。支持不同事件冲突、支持领域事件和存储事件之间的转换、检索由领域模型所产生的所有结果的历史记录、使用事件存储中的数据进行业务预测和分析是常见的事件存储需求。

![包含事件存储的发布订阅时序图](D:\documents\技术文档\md\MicroServices\KnowHow\00 common\images\04\包含事件存储的发布订阅时序图.png)